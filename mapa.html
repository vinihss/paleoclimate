<!DOCTYPE html>
<html>
<head>
    <title>Mapa Paleoclimático com Interpolação</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Incluindo o CSS do Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .legend {
            background: white;
            line-height: 1.5em;
            padding: 10px;
            margin: 10px;
        }
    </style>
</head>
<body>
<h1>Mapa Paleoclimático com Interpolação</h1>
<div id="map"></div>

<!-- Incluindo o JavaScript do Leaflet -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!-- Incluindo o plugin Leaflet.ajax para carregar GeoJSON -->
<script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
<!-- Incluindo o plugin Leaflet.IDW para interpolação -->
<script src="https://unpkg.com/leaflet-idw/leaflet-idw.js"></script>
<script>
    // Inicializando o mapa e configurando a visualização inicial
    var map = L.map('map').setView([-30.0346, -51.2177], 5); // Coordenadas aproximadas do sul do Brasil

    // Adicionando uma camada de mapa base do OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Carregando o GeoJSON do mapa antigo
    var geojsonLayer = new L.GeoJSON.AJAX("http://localhost:63343/paleoclimate/coast.geojson", {
        style: function (feature) {
            return {
                color: "#000", // Cor das bordas do polígono
                weight: 2,
                opacity: 1,
                fillOpacity: 0.2
            };
        }
    }).addTo(map);

    // Função para obter a intensidade com base na informação climática
    function getIntensity(clima) {
        return clima === 'Quente' ? 1.0 :
            clima === 'Frio' ? 0.1 :
                clima === 'Úmido' ? 0.7 :
                    clima === 'Seco' ? 0.5 : 0.0;
    }

    // Função para obter a cor com base na informação climática
    function getColor(clima) {
        return clima === 'Quente' ? '#ff0000' :
            clima === 'Frio' ? '#0000ff' :
                clima === 'Úmido' ? '#00ff00' :
                    clima === 'Seco' ? '#ffff00' :
                        '#ffffff';
    }

    // Função para processar os dados obtidos da API
    function processPoints(data) {
        // Convertendo os pontos para o formato utilizado pelo Leaflet.IDW
        var idwData = data.map(function(ponto) {
            return [ponto.coords[1], ponto.coords[0], getIntensity(ponto.clima)];
        });

        // Adicionando a camada de interpolação (IDW) ao mapa
        var idw = L.idwLayer(idwData, {
            opacity: 0.4,
            cellSize: 10,
            exp: 2,
            max: 1.0
        }).addTo(map);

        // Adicionando os pontos de evidências ao mapa
        data.forEach(function(ponto) {
            var marker = L.circleMarker([ponto.coords[1], ponto.coords[0]], {
                radius: 8,
                fillColor: getColor(ponto.clima),
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            marker.bindPopup("Local: " + ponto.local + "<br>Clima: " + ponto.clima);
        });
    }

    // Função para buscar os dados da API
    function fetchData() {
        fetch('http://0.0.0.0:8000/points')
            .then(response => response.json())
            .then(data => {
                processPoints(data);
            })
            .catch(error => console.error('Erro ao buscar os dados da API:', error));
    }

    // Chamando a função para buscar os dados da API
    fetchData();

    // Adicionando uma legenda ao mapa
    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend'),
            climas = ['Quente', 'Frio', 'Úmido', 'Seco'],
            labels = [];

        div.innerHTML += '<strong>Intensidade Climática</strong><br>';
        for (var i = 0; i < climas.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(climas[i]) + '"></i> ' +
                climas[i] + '<br>';
        }

        return div;
    };

    legend.addTo(map);
</script>
</body>
</html>
